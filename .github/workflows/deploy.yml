name: Deploy to Production

on:
  push:
    branches:
      - feature/create-auto-deploy-system

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Stop IIS Application Pool (if running)
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # appcmd.exeを使用してアプリケーションプールの状態を確認
            $output = & $appcmd list apppool "$appPoolName" 2>&1
            $exitCode = $LASTEXITCODE

            if ($exitCode -eq 0) {
              # アプリケーションプールが存在する場合、停止
              Write-Host "Stopping application pool: $appPoolName"
              & $appcmd stop apppool "$appPoolName" 2>&1 | Out-Null
              
              if ($LASTEXITCODE -eq 0) {
                Start-Sleep -Seconds 2
                Write-Host "Application pool stopped successfully: $appPoolName"
              } else {
                Write-Warning "Failed to stop application pool, but continuing..."
              }
            } else {
              Write-Host "Application pool not found or already stopped: $appPoolName"
            }
          } catch {
            Write-Error "Failed to stop IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Backup current deployment
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $backupPath = "C:\inetpub\wwwroot\smart-invoice-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          if (Test-Path $deployPath) {
            Copy-Item -Path $deployPath -Destination $backupPath -Recurse -Force
            Write-Host "Backup created at: $backupPath"
          }
        shell: powershell

      - name: Deploy to IIS
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $distPath = "${{ github.workspace }}\dist"

          # デプロイ先ディレクトリが存在しない場合は作成
          if (-not (Test-Path $deployPath)) {
            New-Item -ItemType Directory -Path $deployPath -Force
          }

          # 既存ファイルを削除（.gitkeepなどは保持）
          Get-ChildItem -Path $deployPath -Exclude "web.config" | Remove-Item -Recurse -Force

          # ビルド成果物をコピー
          Copy-Item -Path "$distPath\*" -Destination $deployPath -Recurse -Force

          # web.configが存在しない場合はコピー
          if (-not (Test-Path "$deployPath\web.config")) {
            Copy-Item -Path "${{ github.workspace }}\web.config" -Destination "$deployPath\web.config" -Force
          }

          Write-Host "Deployment completed to: $deployPath"
        shell: powershell

      - name: Configure IIS Site and Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $siteName = "AimsSaaSInvoice"
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $port = 3000
          $hostName = "25.20.10.200"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          # エラーが発生しても続行できるように設定（証明書設定はオプショナル）
          $ErrorActionPreference = "Continue"

          try {
            # アプリケーションプールの作成または確認
            $poolExists = & $appcmd list apppool "$appPoolName" 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Creating application pool: $appPoolName"
              & $appcmd add apppool /name:"$appPoolName" /managedRuntimeVersion:"" 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Application pool created: $appPoolName"
              } else {
                Write-Warning "Failed to create application pool, but continuing..."
              }
            }

            # アプリケーションプールの設定
            Write-Host "Configuring application pool: $appPoolName"
            & $appcmd set apppool "$appPoolName" /processModel.idleTimeout:00:00:00 2>&1 | Out-Null

            # サイトの作成または確認
            $siteExists = & $appcmd list site "$siteName" 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Creating website: $siteName"
              & $appcmd add site /name:"$siteName" /physicalPath:"$deployPath" /bindings:"http/*:${port}:" 2>&1 | Out-Null
              
              if ($LASTEXITCODE -eq 0) {
                # アプリケーションプールを設定
                & $appcmd set site "$siteName" /applicationPool:"$appPoolName" 2>&1 | Out-Null
                Write-Host "Website created: $siteName"
              } else {
                Write-Warning "Failed to create website, but continuing..."
              }
            } else {
              Write-Host "Website already exists: $siteName"
              # 物理パスとアプリケーションプールを更新
              & $appcmd set site "$siteName" /physicalPath:"$deployPath" 2>&1 | Out-Null
              & $appcmd set site "$siteName" /applicationPool:"$appPoolName" 2>&1 | Out-Null
            }

            # HTTPSバインディングの確認と作成
            $httpsBindingCheck = & $appcmd list site "$siteName" /config /xml 2>&1
            $httpsBinding = $httpsBindingCheck | Select-String -Pattern "binding.*https.*$port" -ErrorAction SilentlyContinue
            
            if (-not $httpsBinding) {
              Write-Host "Creating HTTPS binding for port $port"
              $bindingResult = & $appcmd set site "$siteName" /+bindings.[protocol='https',bindingInformation="*:${port}:"] 2>&1
              $bindingExitCode = $LASTEXITCODE
              
              if ($bindingExitCode -eq 0) {
                Write-Host "HTTPS binding created for port $port"
              } else {
                Write-Warning "Failed to create HTTPS binding (Exit code: $bindingExitCode)"
                Write-Warning "Output: $bindingResult"
                # HTTPSバインディングの作成に失敗しても続行（HTTPのみでも動作する）
              }
              
              # 証明書の検索と設定（PowerShellを使用）
              # 証明書設定は失敗してもワークフローを続行する（オプショナル）
              Write-Host "Attempting to configure SSL certificate (optional)..."
              $sslConfigSuccess = $false
              
              try {
                # WebAdministrationモジュールのインポートを試行（失敗しても続行）
                $moduleLoaded = $false
                try {
                  Import-Module WebAdministration -ErrorAction Stop
                  $moduleLoaded = $true
                } catch {
                  Write-Warning "Could not import WebAdministration module. SSL certificate configuration will be skipped."
                  Write-Warning "Error: $_"
                }
                
                if ($moduleLoaded) {
                  try {
                    $cert = $null
                    # 方法1: ホスト名で検索
                    $cert = Get-ChildItem -Path Cert:\LocalMachine\My -ErrorAction SilentlyContinue | Where-Object { 
                      $_.Subject -like "*$hostName*" -or ($_.DnsNameList -and $_.DnsNameList.Unicode -like "*$hostName*")
                    } | Select-Object -First 1
                    
                    # 方法2: 有効な証明書を検索
                    if (-not $cert) {
                      $cert = Get-ChildItem -Path Cert:\LocalMachine\My -ErrorAction SilentlyContinue | Where-Object { 
                        $_.NotAfter -gt (Get-Date) -and $_.HasPrivateKey
                      } | Select-Object -First 1
                    }
                    
                    if ($cert) {
                      try {
                        $binding = Get-WebBinding -Name $siteName -Protocol https -HostHeader "" -Port $port -ErrorAction Stop
                        if ($binding) {
                          $binding.AddSslCertificate($cert.Thumbprint, "My")
                          Write-Host "SSL certificate configured: $($cert.Subject)"
                          $sslConfigSuccess = $true
                        }
                      } catch {
                        Write-Warning "HTTPS binding not found or could not configure SSL certificate."
                        Write-Warning "Error: $_"
                        Write-Warning "Certificate thumbprint: $($cert.Thumbprint)"
                      }
                    } else {
                      Write-Warning "No suitable SSL certificate found."
                    }
                  } catch {
                    Write-Warning "Error while searching for SSL certificate: $_"
                  }
                }
              } catch {
                Write-Warning "SSL certificate configuration failed: $_"
              }
              
              if (-not $sslConfigSuccess) {
                Write-Warning "SSL certificate was not configured automatically."
                Write-Warning "Please configure SSL certificate manually in IIS Manager if HTTPS is required."
              }
            } else {
              Write-Host "HTTPS binding already exists"
            }

            Write-Host "IIS configuration completed"
          } catch {
            Write-Error "Failed to configure IIS: $_"
            Write-Error "Error details: $($_.Exception.Message)"
            Write-Error "Stack trace: $($_.ScriptStackTrace)"
            exit 1
          }
        shell: powershell

      - name: Start IIS Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            Write-Host "Starting application pool: $appPoolName"
            & $appcmd start apppool "$appPoolName" 2>&1 | Out-Null
            
            if ($LASTEXITCODE -eq 0) {
              Start-Sleep -Seconds 2
              
              # 状態を確認
              $state = & $appcmd list apppool "$appPoolName" /state 2>&1
              if ($state -match "Started") {
                Write-Host "Application pool started successfully"
              } else {
                Write-Warning "Application pool state: $state"
              }
            } else {
              Write-Error "Failed to start application pool. Exit code: $LASTEXITCODE"
              exit 1
            }
          } catch {
            Write-Error "Failed to start IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Verify deployment
        run: |
          $siteName = "AimsSaaSInvoice"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # サイトの状態を確認
            $siteState = & $appcmd list site "$siteName" /state 2>&1
            
            if ($LASTEXITCODE -eq 0) {
              if ($siteState -notmatch "Started") {
                Write-Host "Starting website: $siteName"
                & $appcmd start site "$siteName" 2>&1 | Out-Null
                Start-Sleep -Seconds 1
              }
              
              # 最終状態を確認
              $finalState = & $appcmd list site "$siteName" 2>&1 | Select-String -Pattern "state:" | ForEach-Object { $_.Line }
              if ($finalState) {
                Write-Host "Website state: $finalState"
              } else {
                Write-Host "Website verification completed"
              }
              Write-Host "Deployment verification completed"
            } else {
              Write-Warning "Website not found: $siteName"
            }
          } catch {
            Write-Error "Failed to verify deployment: $_"
            exit 1
          }
        shell: powershell
