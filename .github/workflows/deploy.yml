name: Deploy to Windows Server

on:
  push:
    branches:
      - feature/auto-deploy
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted # 社内Windowsサーバーで実行

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Create deployment directory
        run: |
          New-Item -ItemType Directory -Path C:\smart-invoice -Force
          New-Item -ItemType Directory -Path C:\smart-invoice\dist -Force
          New-Item -ItemType Directory -Path C:\smart-invoice\backend -Force
          New-Item -ItemType Directory -Path C:\smart-invoice\backend\logs -Force

      - name: Copy frontend files
        run: |
          Copy-Item -Path dist\* -Destination C:\smart-invoice\dist -Recurse -Force

      - name: Copy backend files
        run: |
          Copy-Item -Path backend\dist -Destination C:\smart-invoice\backend\dist -Recurse -Force
          Copy-Item -Path backend\node_modules -Destination C:\smart-invoice\backend\node_modules -Recurse -Force
          Copy-Item -Path backend\package.json -Destination C:\smart-invoice\backend\ -Force
          Copy-Item -Path backend\ecosystem.config.js -Destination C:\smart-invoice\backend\ -Force
          Copy-Item -Path backend\tsconfig.json -Destination C:\smart-invoice\backend\ -Force
          New-Item -ItemType Directory -Path C:\smart-invoice\backend\src\database -Force
          Copy-Item -Path backend\src\database\entities -Destination C:\smart-invoice\backend\src\database\entities -Recurse -Force
          Copy-Item -Path backend\src\database\migrations -Destination C:\smart-invoice\backend\src\database\migrations -Recurse -Force
          # SSL証明書ディレクトリを作成
          New-Item -ItemType Directory -Path C:\smart-invoice\backend\ssl -Force
          # 証明書ファイルをコピー（存在する場合）
          if (Test-Path "backend\ssl\server.key") {
            Copy-Item -Path backend\ssl\server.key -Destination C:\smart-invoice\backend\ssl\server.key -Force
            Write-Host "SSL key file copied"
          } else {
            Write-Host "SSL key file not found, HTTPS will not be enabled"
          }
          if (Test-Path "backend\ssl\server.crt") {
            Copy-Item -Path backend\ssl\server.crt -Destination C:\smart-invoice\backend\ssl\server.crt -Force
            Write-Host "SSL certificate file copied"
          } else {
            Write-Host "SSL certificate file not found, HTTPS will not be enabled"
          }

      - name: Install PM2 globally
        run: |
          if (!(Get-Command pm2 -ErrorAction SilentlyContinue)) {
            Write-Host "Installing PM2..."
            npm install -g pm2
          } else {
            Write-Host "PM2 is already installed"
          }

      - name: Install backend dependencies in deployment directory
        working-directory: C:\smart-invoice\backend
        run: npm install

      - name: Restart application with PM2
        working-directory: C:\smart-invoice\backend
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $env:PM2_HOME = "C:\etc\.pm2"
          $env:HOMEPATH = $env:USERPROFILE
          $env:HOME = $env:USERPROFILE

          Write-Host "Attempting to connect to PM2 daemon..."

          # PM2に接続できるかテスト
          $pm2Test = pm2 ping 2>&1
          if ($LASTEXITCODE -ne 0 -or $pm2Test -like "*EPERM*" -or $pm2Test -like "*connect*") {
            Write-Host "WARNING: Cannot connect to PM2 daemon. This may be because:"
            Write-Host "  1. PM2 is running under a different user account"
            Write-Host "  2. PM2 daemon is not running"
            Write-Host "  3. Permission issues with PM2 socket"
            Write-Host ""
            Write-Host "Deployment completed successfully, but application restart is required."
            Write-Host "Please restart manually using one of the following methods:"
            Write-Host "  Method 1: pm2 restart smart-invoice-backend"
            Write-Host "  Method 2: pm2 reload smart-invoice-backend"
            Write-Host "  Method 3: cd C:\smart-invoice\backend && pm2 start ecosystem.config.js"
            exit 0
          }

          # PM2に接続できた場合のみ、アプリケーションを再起動
          Write-Host "Connected to PM2 daemon successfully"
          $pm2List = pm2 list 2>&1
          if ($pm2List -like "*smart-invoice-backend*") {
            Write-Host "Reloading application (zero-downtime)..."
            pm2 reload smart-invoice-backend 2>&1
          } else {
            Write-Host "Starting application..."
            pm2 start ecosystem.config.js 2>&1
            pm2 save 2>&1
          }
          pm2 status
