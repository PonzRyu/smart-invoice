name: Deploy to Production

on:
  push:
    branches:
      - feature/create-auto-deploy-system

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Stop IIS Application Pool (if running)
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # appcmd.exeを使用してアプリケーションプールの状態を確認
            $output = & $appcmd list apppool "$appPoolName" 2>&1
            $exitCode = $LASTEXITCODE

            if ($exitCode -eq 0) {
              # アプリケーションプールが存在する場合、停止
              Write-Host "Stopping application pool: $appPoolName"
              & $appcmd stop apppool "$appPoolName" 2>&1 | Out-Null
              
              if ($LASTEXITCODE -eq 0) {
                Start-Sleep -Seconds 2
                Write-Host "Application pool stopped successfully: $appPoolName"
              } else {
                Write-Warning "Failed to stop application pool, but continuing..."
              }
            } else {
              Write-Host "Application pool not found or already stopped: $appPoolName"
            }
          } catch {
            Write-Error "Failed to stop IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Backup current deployment
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $backupPath = "C:\inetpub\wwwroot\smart-invoice-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          if (Test-Path $deployPath) {
            Copy-Item -Path $deployPath -Destination $backupPath -Recurse -Force
            Write-Host "Backup created at: $backupPath"
          }
        shell: powershell

      - name: Deploy to IIS
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $distPath = "${{ github.workspace }}\dist"

          # デプロイ先ディレクトリが存在しない場合は作成
          if (-not (Test-Path $deployPath)) {
            New-Item -ItemType Directory -Path $deployPath -Force
          }

          # 既存ファイルを削除（.gitkeepなどは保持）
          Get-ChildItem -Path $deployPath -Exclude "web.config" | Remove-Item -Recurse -Force

          # ビルド成果物をコピー
          Copy-Item -Path "$distPath\*" -Destination $deployPath -Recurse -Force

          # web.configが存在しない場合はコピー
          if (-not (Test-Path "$deployPath\web.config")) {
            Copy-Item -Path "${{ github.workspace }}\web.config" -Destination "$deployPath\web.config" -Force
          }

          Write-Host "Deployment completed to: $deployPath"
        shell: powershell

      - name: Configure IIS Site and Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $siteName = "AimsSaaSInvoice"
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $hostName = "25.20.10.200"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          # エラーが発生しても続行できるように設定（証明書設定はオプショナル）
          $ErrorActionPreference = "Continue"

          try {
            # アプリケーションプールの作成または確認
            $poolExists = & $appcmd list apppool "$appPoolName" 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Creating application pool: $appPoolName"
              & $appcmd add apppool /name:"$appPoolName" /managedRuntimeVersion:"" 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Application pool created: $appPoolName"
              } else {
                Write-Warning "Failed to create application pool, but continuing..."
              }
            }

            # アプリケーションプールの設定
            Write-Host "Configuring application pool: $appPoolName"
            & $appcmd set apppool "$appPoolName" /processModel.idleTimeout:00:00:00 2>&1 | Out-Null

            Write-Host "IIS configuration completed"
          } catch {
            Write-Error "Failed to configure IIS: $_"
            Write-Error "Error details: $($_.Exception.Message)"
            Write-Error "Stack trace: $($_.ScriptStackTrace)"
            exit 1
          }
        shell: powershell

      - name: Start IIS Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            Write-Host "Starting application pool: $appPoolName"
            & $appcmd start apppool "$appPoolName" 2>&1 | Out-Null
            
            if ($LASTEXITCODE -eq 0) {
              Start-Sleep -Seconds 2
              
              # 状態を確認（WebAdministrationモジュールを使用）
              try {
                Import-Module WebAdministration -ErrorAction Stop
                $state = Get-WebAppPoolState -Name $appPoolName -ErrorAction Stop
                if ($state.Value -eq "Started") {
                  Write-Host "Application pool started successfully"
                } else {
                  Write-Warning "Application pool state: $($state.Value)"
                }
              } catch {
                # WebAdministrationが使えない場合はappcmdの出力をパース
                Write-Host "WebAdministration not available, using appcmd to check state..."
                $appPoolInfo = & $appcmd list apppool "$appPoolName" 2>&1
                if ($appPoolInfo -match "state:\s*(Started|Stopped)") {
                  $state = $matches[1]
                  if ($state -eq "Started") {
                    Write-Host "Application pool started successfully"
                  } else {
                    Write-Warning "Application pool state: $state"
                  }
                } else {
                  Write-Host "Application pool start command completed (unable to verify state)"
                }
              }
            } else {
              Write-Error "Failed to start application pool. Exit code: $LASTEXITCODE"
              exit 1
            }
          } catch {
            Write-Error "Failed to start IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Verify deployment
        run: |
          $siteName = "AimsSaaSInvoice"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # サイトの存在確認
            $siteInfo = & $appcmd list site "$siteName" 2>&1
            $siteExists = $LASTEXITCODE -eq 0
            
            if ($siteExists) {
              # WebAdministrationモジュールを使用して状態を確認
              try {
                Import-Module WebAdministration -ErrorAction Stop
                $site = Get-WebSite -Name $siteName -ErrorAction Stop
                $siteState = $site.State
                
                if ($siteState -ne "Started") {
                  Write-Host "Starting website: $siteName (current state: $siteState)"
                  Start-WebSite -Name $siteName -ErrorAction Stop
                  Start-Sleep -Seconds 2
                  
                  # 状態を再確認
                  $site = Get-WebSite -Name $siteName -ErrorAction Stop
                  Write-Host "Website state: $($site.State)"
                } else {
                  Write-Host "Website is already started: $siteName"
                }
              } catch {
                # WebAdministrationが使えない場合はappcmdを使用
                Write-Host "WebAdministration not available, using appcmd..."
                
                # サイト情報から状態を抽出
                $siteInfoOutput = & $appcmd list site "$siteName" 2>&1
                if ($siteInfoOutput -match "state:\s*(Started|Stopped)") {
                  $currentState = $matches[1]
                  if ($currentState -ne "Started") {
                    Write-Host "Starting website: $siteName (current state: $currentState)"
                    & $appcmd start site "$siteName" 2>&1 | Out-Null
                    Start-Sleep -Seconds 2
                    
                    # 最終状態を確認
                    $siteInfoOutput = & $appcmd list site "$siteName" 2>&1
                    if ($siteInfoOutput -match "state:\s*(Started|Stopped)") {
                      Write-Host "Website state: $($matches[1])"
                    }
                  } else {
                    Write-Host "Website is already started: $siteName"
                  }
                } else {
                  Write-Host "Starting website: $siteName"
                  & $appcmd start site "$siteName" 2>&1 | Out-Null
                  Start-Sleep -Seconds 2
                }
              }
              
              Write-Host "Deployment verification completed"
            } else {
              Write-Warning "Website not found: $siteName"
              Write-Warning "Please check if the website was created successfully in the previous steps"
            }
          } catch {
            Write-Error "Failed to verify deployment: $_"
            exit 1
          }
        shell: powershell
