name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'

      - name: Install dependencies (frontend)
        run: npm ci

      - name: Install dependencies (backend)
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Build application (frontend)
        run: npm run build
        env:
          NODE_ENV: production
          # バックエンドAPIのURLを設定
          # 空文字（相対パス）にすることで、IISリバースプロキシ経由で/apiにアクセス
          # 異なるドメインで提供する場合は絶対URLを指定
          # 例: VITE_API_BASE_URL: https://api.example.com
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '' }}

      - name: Stop IIS Application Pool (if running)
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # appcmd.exeを使用してアプリケーションプールの状態を確認
            $output = & $appcmd list apppool "$appPoolName" 2>&1
            $exitCode = $LASTEXITCODE

            if ($exitCode -eq 0) {
              # アプリケーションプールが存在する場合、停止
              Write-Host "Stopping application pool: $appPoolName"
              & $appcmd stop apppool "$appPoolName" 2>&1 | Out-Null
              
              if ($LASTEXITCODE -eq 0) {
                Start-Sleep -Seconds 2
                Write-Host "Application pool stopped successfully: $appPoolName"
              } else {
                Write-Warning "Failed to stop application pool, but continuing..."
              }
            } else {
              Write-Host "Application pool not found or already stopped: $appPoolName"
            }
          } catch {
            Write-Error "Failed to stop IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Backup current deployment
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $backupPath = "C:\inetpub\wwwroot\smart-invoice-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          if (Test-Path $deployPath) {
            Copy-Item -Path $deployPath -Destination $backupPath -Recurse -Force
            Write-Host "Backup created at: $backupPath"
          }
        shell: powershell

      - name: Deploy to IIS
        run: |
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $distPath = "${{ github.workspace }}\dist"

          # デプロイ先ディレクトリが存在しない場合は作成
          if (-not (Test-Path $deployPath)) {
            New-Item -ItemType Directory -Path $deployPath -Force
          }

          # 既存ファイルを削除（.gitkeepなどは保持）
          Get-ChildItem -Path $deployPath -Exclude "web.config" | Remove-Item -Recurse -Force

          # ビルド成果物をコピー
          Copy-Item -Path "$distPath\*" -Destination $deployPath -Recurse -Force

          # web.configが存在しない場合はコピー
          if (-not (Test-Path "$deployPath\web.config")) {
            Copy-Item -Path "${{ github.workspace }}\web.config" -Destination "$deployPath\web.config" -Force
          }

          Write-Host "Deployment completed to: $deployPath"
        shell: powershell

      - name: Stop backend server (if running)
        run: |
          # タスクスケジューラのタスクを停止
          $taskName = "SmartInvoiceBackendServer"
          $existingTask = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
          if ($existingTask) {
            Write-Host "Stopping scheduled task: $taskName"
            Stop-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
          }

          # ポート3001を使用しているプロセスを停止
          $processes = Get-NetTCPConnection -LocalPort 3001 -ErrorAction SilentlyContinue | 
            Select-Object -ExpandProperty OwningProcess -Unique

          if ($processes) {
            foreach ($pid in $processes) {
              $proc = Get-Process -Id $pid -ErrorAction SilentlyContinue
              if ($proc -and $proc.ProcessName -eq "node") {
                Write-Host "Stopping Node.js process on port 3001 (PID: $pid)"
                Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
                Start-Sleep -Seconds 2
              }
            }
          }

          Write-Host "Backend server stopped (if it was running)"
        shell: powershell

      - name: Backup current backend deployment
        run: |
          $backendDeployPath = "C:\apps\smart-invoice-backend"
          $backendBackupPath = "C:\apps\smart-invoice-backend-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          if (Test-Path $backendDeployPath) {
            Copy-Item -Path $backendDeployPath -Destination $backendBackupPath -Recurse -Force
            Write-Host "Backend backup created at: $backendBackupPath"
          }
        shell: powershell

      - name: Deploy backend
        run: |
          $backendDeployPath = "C:\apps\smart-invoice-backend"
          $backendSourcePath = "${{ github.workspace }}\backend"

          # デプロイ先ディレクトリが存在しない場合は作成
          if (-not (Test-Path $backendDeployPath)) {
            New-Item -ItemType Directory -Path $backendDeployPath -Force | Out-Null
          }

          # distディレクトリとnode_modulesをコピー
          $distPath = "$backendSourcePath\dist"
          if (Test-Path $distPath) {
            # distディレクトリの内容をコピー
            if (Test-Path "$backendDeployPath\dist") {
              Remove-Item -Path "$backendDeployPath\dist" -Recurse -Force
            }
            Copy-Item -Path "$distPath" -Destination "$backendDeployPath\dist" -Recurse -Force
          }

          # package.jsonとpackage-lock.jsonをコピー
          Copy-Item -Path "$backendSourcePath\package.json" -Destination "$backendDeployPath\package.json" -Force
          Copy-Item -Path "$backendSourcePath\package-lock.json" -Destination "$backendDeployPath\package-lock.json" -Force

          # node_modulesをコピー（または再インストール）
          Write-Host "Installing backend dependencies in deployment directory..."
          Set-Location $backendDeployPath
          npm ci --production

          Write-Host "Backend deployment completed to: $backendDeployPath"
        shell: powershell

      - name: Create backend .env file
        run: |
          $backendDeployPath = "C:\apps\smart-invoice-backend"
          $envFilePath = "$backendDeployPath\.env"

          # .envファイルの内容を作成（GitHub Secretsから取得）
          $dbHost = "${{ secrets.DB_HOST }}"
          $dbPort = "${{ secrets.DB_PORT }}"
          $dbUsername = "${{ secrets.DB_USERNAME }}"
          $dbPassword = "${{ secrets.DB_PASSWORD }}"
          $dbDatabase = "${{ secrets.DB_DATABASE }}"
          $backendPort = "${{ secrets.BACKEND_PORT }}"

          # デフォルト値を設定
          if ([string]::IsNullOrEmpty($dbHost)) { $dbHost = "localhost" }
          if ([string]::IsNullOrEmpty($dbPort)) { $dbPort = "5432" }
          if ([string]::IsNullOrEmpty($dbUsername)) { $dbUsername = "postgres" }
          if ([string]::IsNullOrEmpty($dbPassword)) { $dbPassword = "postgres" }
          if ([string]::IsNullOrEmpty($dbDatabase)) { $dbDatabase = "postgres" }
          if ([string]::IsNullOrEmpty($backendPort)) { $backendPort = "3001" }

          # .envファイルの内容を作成
          $envLines = @(
            "DB_HOST=$dbHost",
            "DB_PORT=$dbPort",
            "DB_USERNAME=$dbUsername",
            "DB_PASSWORD=$dbPassword",
            "DB_DATABASE=$dbDatabase",
            "PORT=$backendPort",
            "NODE_ENV=production"
          )

          $envLines | Out-File -FilePath $envFilePath -Encoding utf8 -Force
          Write-Host "Backend .env file created at: $envFilePath"
        shell: powershell

      - name: Run database migrations
        run: |
          $backendDeployPath = "C:\apps\smart-invoice-backend"

          Write-Host "Running database migrations..."
          Set-Location $backendDeployPath

          # 環境変数を設定
          $env:NODE_ENV = "production"

          # 本番環境用のマイグレーションを実行（JavaScriptファイルを使用）
          Write-Host "Executing database migrations using production build..."
          npm run migration:run:production

          if ($LASTEXITCODE -eq 0) {
            Write-Host "Database migrations completed successfully"
          } else {
            Write-Error "Database migration failed with exit code: $LASTEXITCODE"
            exit 1
          }
        shell: powershell

      - name: Setup backend server scheduled task
        run: |
          $backendDeployPath = "C:\apps\smart-invoice-backend"
          $taskName = "SmartInvoiceBackendServer"

          # 既存のタスクが存在する場合は削除
          $existingTask = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
          if ($existingTask) {
            Write-Host "Removing existing scheduled task: $taskName"
            Unregister-ScheduledTask -TaskName $taskName -Confirm:$false -ErrorAction SilentlyContinue
          }

          # Node.jsのパスを取得
          $nodePath = (Get-Command node -ErrorAction Stop).Source
          Write-Host "Node.js path: $nodePath"

          # タスクスケジューラにタスクを作成
          $action = New-ScheduledTaskAction -Execute $nodePath `
            -Argument "`"$backendDeployPath\dist\index.js`"" `
            -WorkingDirectory $backendDeployPath

          $trigger = New-ScheduledTaskTrigger -AtStartup

          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" `
            -LogonType ServiceAccount `
            -RunLevel Highest

          $settings = New-ScheduledTaskSettingsSet `
            -AllowStartIfOnBatteries `
            -DontStopIfGoingOnBatteries `
            -StartWhenAvailable `
            -RestartCount 3 `
            -RestartInterval (New-TimeSpan -Minutes 1)

          Register-ScheduledTask `
            -TaskName $taskName `
            -Action $action `
            -Trigger $trigger `
            -Principal $principal `
            -Settings $settings `
            -Description "Smart Invoice Backend API Server"

          Write-Host "Scheduled task created successfully: $taskName"
        shell: powershell

      - name: Start backend server
        run: |
          $taskName = "SmartInvoiceBackendServer"
          $backendDeployPath = "C:\apps\smart-invoice-backend"

          Write-Host "Starting backend server via scheduled task: $taskName"
          Start-ScheduledTask -TaskName $taskName

          # サーバーが起動するまで待機（最大30秒）
          Write-Host "Waiting for backend server to start..."
          $maxWaitTime = 30
          $waitInterval = 2
          $elapsed = 0

          while ($elapsed -lt $maxWaitTime) {
            Start-Sleep -Seconds $waitInterval
            $elapsed += $waitInterval
            
            # ポート3001をチェック
            $tcpConnection = Get-NetTCPConnection -LocalPort 3001 -ErrorAction SilentlyContinue
            if ($tcpConnection) {
              Write-Host "Port 3001 is listening"
            }
          }
        shell: powershell

      - name: Configure IIS Site and Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $siteName = "AimsSaaSInvoice"
          $deployPath = "C:\inetpub\wwwroot\smart-invoice"
          $hostName = "25.20.10.200"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          # エラーが発生しても続行できるように設定（証明書設定はオプショナル）
          $ErrorActionPreference = "Continue"

          try {
            # アプリケーションプールの作成または確認
            $poolExists = & $appcmd list apppool "$appPoolName" 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Creating application pool: $appPoolName"
              & $appcmd add apppool /name:"$appPoolName" /managedRuntimeVersion:"" 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Application pool created: $appPoolName"
              } else {
                Write-Warning "Failed to create application pool, but continuing..."
              }
            }

            # アプリケーションプールの設定
            Write-Host "Configuring application pool: $appPoolName"
            & $appcmd set apppool "$appPoolName" /processModel.idleTimeout:00:00:00 2>&1 | Out-Null

            Write-Host "IIS configuration completed"
          } catch {
            Write-Error "Failed to configure IIS: $_"
            Write-Error "Error details: $($_.Exception.Message)"
            Write-Error "Stack trace: $($_.ScriptStackTrace)"
            exit 1
          }
        shell: powershell

      - name: Start IIS Application Pool
        run: |
          $appPoolName = "AimsSaaSInvoiceAppPool"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            Write-Host "Starting application pool: $appPoolName"
            & $appcmd start apppool "$appPoolName" 2>&1 | Out-Null
            
            if ($LASTEXITCODE -eq 0) {
              Start-Sleep -Seconds 2
              
              # 状態を確認（WebAdministrationモジュールを使用）
              try {
                Import-Module WebAdministration -ErrorAction Stop
                $state = Get-WebAppPoolState -Name $appPoolName -ErrorAction Stop
                if ($state.Value -eq "Started") {
                  Write-Host "Application pool started successfully"
                } else {
                  Write-Warning "Application pool state: $($state.Value)"
                }
              } catch {
                # WebAdministrationが使えない場合はappcmdの出力をパース
                Write-Host "WebAdministration not available, using appcmd to check state..."
                $appPoolInfo = & $appcmd list apppool "$appPoolName" 2>&1
                if ($appPoolInfo -match "state:\s*(Started|Stopped)") {
                  $state = $matches[1]
                  if ($state -eq "Started") {
                    Write-Host "Application pool started successfully"
                  } else {
                    Write-Warning "Application pool state: $state"
                  }
                } else {
                  Write-Host "Application pool start command completed (unable to verify state)"
                }
              }
            } else {
              Write-Error "Failed to start application pool. Exit code: $LASTEXITCODE"
              exit 1
            }
          } catch {
            Write-Error "Failed to start IIS Application Pool: $_"
            exit 1
          }
        shell: powershell

      - name: Verify deployment
        run: |
          $siteName = "AimsSaaSInvoice"
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          if (-not (Test-Path $appcmd)) {
            Write-Error "appcmd.exe not found. IIS may not be installed."
            exit 1
          }

          try {
            # サイトの存在確認
            $siteInfo = & $appcmd list site "$siteName" 2>&1
            $siteExists = $LASTEXITCODE -eq 0
            
            if ($siteExists) {
              # WebAdministrationモジュールを使用して状態を確認
              try {
                Import-Module WebAdministration -ErrorAction Stop
                $site = Get-WebSite -Name $siteName -ErrorAction Stop
                $siteState = $site.State
                
                if ($siteState -ne "Started") {
                  Write-Host "Starting website: $siteName (current state: $siteState)"
                  Start-WebSite -Name $siteName -ErrorAction Stop
                  Start-Sleep -Seconds 2
                  
                  # 状態を再確認
                  $site = Get-WebSite -Name $siteName -ErrorAction Stop
                  Write-Host "Website state: $($site.State)"
                } else {
                  Write-Host "Website is already started: $siteName"
                }
              } catch {
                # WebAdministrationが使えない場合はappcmdを使用
                Write-Host "WebAdministration not available, using appcmd..."
                
                # サイト情報から状態を抽出
                $siteInfoOutput = & $appcmd list site "$siteName" 2>&1
                if ($siteInfoOutput -match "state:\s*(Started|Stopped)") {
                  $currentState = $matches[1]
                  if ($currentState -ne "Started") {
                    Write-Host "Starting website: $siteName (current state: $currentState)"
                    & $appcmd start site "$siteName" 2>&1 | Out-Null
                    Start-Sleep -Seconds 2
                    
                    # 最終状態を確認
                    $siteInfoOutput = & $appcmd list site "$siteName" 2>&1
                    if ($siteInfoOutput -match "state:\s*(Started|Stopped)") {
                      Write-Host "Website state: $($matches[1])"
                    }
                  } else {
                    Write-Host "Website is already started: $siteName"
                  }
                } else {
                  Write-Host "Starting website: $siteName"
                  & $appcmd start site "$siteName" 2>&1 | Out-Null
                  Start-Sleep -Seconds 2
                }
              }
              
              Write-Host "Deployment verification completed"
            } else {
              Write-Warning "Website not found: $siteName"
              Write-Warning "Please check if the website was created successfully in the previous steps"
            }
          } catch {
            Write-Error "Failed to verify deployment: $_"
            exit 1
          }
        shell: powershell
